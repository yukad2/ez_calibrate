<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>リモコン（別ウィンドウ）</title>
  <style>
    :root {
      color-scheme: light dark;
    }

    body,
    html {
      margin: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
    }

    .control-panel {
      max-width: 360px;
      margin: 0 auto;
      padding: 24px 20px 40px;
      box-sizing: border-box;
    }

    h1 {
      margin-top: 0;
      font-size: 1.4rem;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="url"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      font-size: 0.95rem;
    }

    button {
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background: #0066cc;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }

    button:hover {
      background: #004c99;
    }

    form + form,
    form + hr,
    hr + form,
    hr + button {
      margin-top: 16px;
    }

    hr {
      margin: 20px 0;
      border: none;
      border-top: 1px solid rgba(0, 0, 0, 0.15);
    }

    .info-box {
      margin-top: 24px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      font-size: 0.85rem;
      min-height: 3rem;
      color: rgba(0, 0, 0, 0.85);
    }

    .hint {
      margin-top: 12px;
      font-size: 0.8rem;
      color: rgba(0, 0, 0, 0.6);
      line-height: 1.5;
    }
  </style>
</head>
<body>
  <div class="control-panel">
    <h1>リモコン</h1>
    <form id="colorForm">
      <label for="colorInput">色 (CSSカラー名または #HEX):</label>
      <input type="text" id="colorInput" name="color" placeholder="#ff0000" />
      <button type="button" id="colorButton">色を設定</button>
    </form>
    <hr />
    <form id="imageForm">
      <label for="imageUrl">画像URL:</label>
      <input type="url" id="imageUrl" name="imageUrl" placeholder="https://example.com/image.jpg" />
      <button type="button" id="imageButton">画像を表示</button>
    </form>
    <div class="hint">
      開いている表示画面（display.html またはトップページのプレビュー）に即座に反映されます。
    </div>
    <div class="info-box" id="info">色や画像を設定するとここに表示されます。</div>
  </div>

  <script>
    const infoBox = document.getElementById('info');
    const broadcastChannel = 'BroadcastChannel' in window ? new BroadcastChannel('ez-calibrate-control') : null;

    function getOpenerWindow() {
      return window.opener && !window.opener.closed ? window.opener : null;
    }

    function updateInfo(message) {
      infoBox.textContent = message;
    }

    function reportCommand(command) {
      if (!command || typeof command !== 'object') {
        return;
      }
      const { type, value } = command;
      if (type === 'color' && typeof value === 'string') {
        updateInfo(`色: ${value}`);
      } else if (type === 'image' && typeof value === 'string') {
        updateInfo(`画像: ${value}`);
      }
    }

    function dispatchCommand(command) {
      let delivered = false;

      if (broadcastChannel) {
        broadcastChannel.postMessage(command);
        delivered = true;
      }

      const openerWindow = getOpenerWindow();
      if (openerWindow) {
        openerWindow.postMessage(
          {
            type: 'ez-calibrate-command',
            payload: command,
            broadcasted: !!broadcastChannel,
          },
          '*',
        );
        delivered = true;
      }

      if (!delivered) {
        updateInfo('制御できる表示画面が見つかりません。');
      }
    }

    function setColor() {
      const color = document.getElementById('colorInput').value.trim() || '#ffffff';
      reportCommand({ type: 'color', value: color });
      dispatchCommand({ type: 'color', value: color });
    }

    function setImage() {
      const url = document.getElementById('imageUrl').value.trim();
      if (!url) {
        updateInfo('画像URLを入力してください。');
        return;
      }
      reportCommand({ type: 'image', value: url });
      dispatchCommand({ type: 'image', value: url });
    }

    document.getElementById('colorButton').addEventListener('click', setColor);
    document.getElementById('imageButton').addEventListener('click', setImage);

    document.getElementById('colorInput').addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        setColor();
      }
    });

    document.getElementById('imageUrl').addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        setImage();
      }
    });

    broadcastChannel?.addEventListener('message', (event) => {
      reportCommand(event.data);
    });

    window.addEventListener('message', (event) => {
      const data = event.data;
      if (!data || typeof data !== 'object') {
        return;
      }

      if (data.type === 'ez-calibrate-command' && data.payload && typeof data.payload === 'object') {
        reportCommand(data.payload);
      }
    });

    window.addEventListener('beforeunload', () => {
      broadcastChannel?.close();
    });

    if (!broadcastChannel) {
      if (getOpenerWindow()) {
        updateInfo('BroadcastChannel 非対応のため、このウィンドウを開いた画面のみ操作できます。');
      } else {
        updateInfo('このブラウザでは別ウィンドウ制御がサポートされていません。');
      }
    }
  </script>
</body>
</html>
