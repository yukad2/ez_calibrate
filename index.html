<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>カラー・画像表示リモコン</title>
  <style>
    :root {
      color-scheme: light dark;
    }

    body,
    html {
      margin: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .container {
      display: flex;
      flex-direction: row;
      height: 100%;
    }

    .control-panel {
      width: 320px;
      padding: 24px 20px;
      background: #f5f5f5;
      box-sizing: border-box;
      overflow-y: auto;
      border-right: 1px solid rgba(0, 0, 0, 0.08);
    }

    .control-panel h1 {
      margin-top: 0;
      font-size: 1.4rem;
    }

    .control-panel label {
      font-size: 0.9rem;
      font-weight: 600;
      display: block;
      margin-bottom: 4px;
    }

    .control-panel input[type="text"],
    .control-panel input[type="url"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 4px;
      font-size: 0.95rem;
    }

    .control-panel button {
      margin-top: 8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      background: #0066cc;
      color: white;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }

    .control-panel button:hover {
      background: #004c99;
    }

    .control-panel form + form,
    .control-panel form + hr,
    .control-panel hr + form,
    .control-panel hr + button {
      margin-top: 16px;
    }

    .control-panel hr {
      margin: 20px 0;
      border: none;
      border-top: 1px solid rgba(0, 0, 0, 0.15);
    }

    .info-box {
      margin-top: 24px;
      padding: 12px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      font-size: 0.85rem;
      min-height: 3rem;
    }

    .display-area {
      flex: 1;
      position: relative;
    }

    iframe {
      border: none;
      width: 100%;
      height: 100%;
      background: #000;
    }

    @media (max-width: 960px) {
      .container {
        flex-direction: column;
      }

      .control-panel {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="control-panel">
      <h1>リモコン</h1>
      <form id="colorForm">
        <label for="colorInput">色 (CSSカラー名または #HEX):</label>
        <input type="text" id="colorInput" name="color" placeholder="#ff0000" />
        <button type="button" id="colorButton">色を設定</button>
      </form>
      <hr />
      <form id="imageForm">
        <label for="imageUrl">画像URL:</label>
        <input type="url" id="imageUrl" name="imageUrl" placeholder="https://example.com/image.jpg" />
        <button type="button" id="imageButton">画像を表示</button>
      </form>
      <hr />
      <button type="button" id="fullscreenButton">全画面表示</button>
      <button type="button" id="popoutButton">リモコンを別ウィンドウで開く</button>
      <div class="info-box" id="info">色や画像を設定するとここに表示されます。</div>
    </div>
    <div class="display-area">
      <iframe id="displayFrame" src="display.html" title="表示画面"></iframe>
    </div>
  </div>

  <script>
    const displayFrame = document.getElementById('displayFrame');
    const infoBox = document.getElementById('info');
    const broadcastChannel = 'BroadcastChannel' in window ? new BroadcastChannel('ez-calibrate-control') : null;
    let remoteWindow = null;

    function updateInfo(message) {
      infoBox.textContent = message;
    }

    function sendMessage(data) {
      if (!displayFrame.contentWindow) {
        return;
      }
      displayFrame.contentWindow.postMessage(data, '*');
    }

    function applyCommand(command) {
      if (!command || typeof command !== 'object') {
        return;
      }
      const { type, value } = command;
      if (type === 'color' && typeof value === 'string') {
        sendMessage({ type: 'color', value });
        updateInfo(`色: ${value}`);
      } else if (type === 'image' && typeof value === 'string' && value.trim() !== '') {
        sendMessage({ type: 'image', value });
        updateInfo(`画像: ${value}`);
      }
    }

    function setColor() {
      const color = document.getElementById('colorInput').value.trim() || '#ffffff';
      applyCommand({ type: 'color', value: color });
      broadcastChannel?.postMessage({ type: 'color', value: color });
    }

    function setImage() {
      const url = document.getElementById('imageUrl').value.trim();
      if (!url) {
        updateInfo('画像URLを入力してください。');
        return;
      }
      applyCommand({ type: 'image', value: url });
      broadcastChannel?.postMessage({ type: 'image', value: url });
    }

    function openRemoteWindow() {
      if (remoteWindow && !remoteWindow.closed) {
        remoteWindow.focus();
        return;
      }
      remoteWindow = window.open('remote.html', 'ezCalibrateRemote', 'width=420,height=680');
      if (!remoteWindow) {
        updateInfo('ポップアップがブロックされました。別ウィンドウ表示を許可してください。');
      }
    }

    function enterFullScreen() {
      const iframe = displayFrame;
      if (iframe.requestFullscreen) {
        iframe.requestFullscreen();
      } else if (iframe.webkitRequestFullscreen) {
        iframe.webkitRequestFullscreen();
      } else if (iframe.mozRequestFullScreen) {
        iframe.mozRequestFullScreen();
      } else if (iframe.msRequestFullscreen) {
        iframe.msRequestFullscreen();
      } else {
        updateInfo('このブラウザでは全画面APIがサポートされていません。');
      }
    }

    document.getElementById('colorButton').addEventListener('click', setColor);
    document.getElementById('imageButton').addEventListener('click', setImage);
    document.getElementById('fullscreenButton').addEventListener('click', enterFullScreen);
    document.getElementById('popoutButton').addEventListener('click', openRemoteWindow);

    document.getElementById('colorInput').addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        setColor();
      }
    });

    document.getElementById('imageUrl').addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        setImage();
      }
    });

    broadcastChannel?.addEventListener('message', (event) => {
      applyCommand(event.data);
    });

    window.addEventListener('beforeunload', () => {
      broadcastChannel?.close();
      if (remoteWindow && !remoteWindow.closed) {
        remoteWindow.close();
      }
    });
  </script>
</body>
</html>
